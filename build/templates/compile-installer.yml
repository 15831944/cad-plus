#Install CodeSigning task from https://marketplace.visualstudio.com/items?itemName=stefankert.codesigning

parameters:
- name: version
  type: string
  default: ''
- name: packageSuffix
  type: string
  default: ''
- name: artifactName
  type: string
  default: ''
- name: enabled
  default: true
  
steps:

  - task: VSBuild@1
    condition: ${{ parameters.enabled }}
    displayName: 'Build installer'
    inputs:
      solution: 'installer\Installer.sln'
      platform: 'x64'
      configuration: 'Release'
      msbuildArgs: '/p:PackageVersion=${{ parameters.version }} "/p:PackageNameSuffix=${{ parameters.packageSuffix }}"'

  - task: codesigning@2
    condition: ${{ parameters.enabled }}
    displayName: 'Signing .msi installers'
    inputs:
      secureFileId: xarial-code-signing.pfx
      signCertPassword: $(CODE_SIGN_CERT_PWD)
      files: '_build/*.msi'
      timeServer: 'http://timestamp.comodoca.com'
      hashingAlgorithm: 'SHA256'
      description: 'CAD+ Toolset'

  - task: CopyFiles@2
    condition: ${{ parameters.enabled }}
    displayName: 'Copy Installer Files'
    inputs:
      SourceFolder: '_build'
      Contents: '*.msi'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/installer/${{ parameters.artifactName }}'