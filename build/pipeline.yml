#Install CodeSigning task from https://marketplace.visualstudio.com/items?itemName=stefankert.codesigning

trigger:
  branches:
    include:
    - master
    - dev

stages:

- stage: 'Build'
  variables:
  - group: build-vars
  - name: buildConfiguration
    value: 'Release'
  - name: buildPlatform
    value: 'Any CPU'
  - name: installerPlatform
    value: 'x64'

  jobs:
  - job: BuildTestInstaller
    pool:
      name: 'Azure Pipelines'
      vmImage: windows-latest
      demands:
        - msbuild
        - visualstudio

    steps:
      - task: NuGetToolInstaller@0
        displayName: 'Use NuGet'

      - task: NuGetCommand@2
        displayName: 'NuGet restore'
        inputs:
          restoreSolution: 'cad-plus.sln'

      - task: PowerShell@2
        displayName: 'Set assembly version'
        inputs:
          filePath: 'build/set-version.ps1'
          arguments: '-build "$(Build.Date:yyyyMMdd)$(Build.Rev:.r)5" -revision "2"'

      - task: VSBuild@1
        displayName: 'Build source code and unit tests'
        inputs:
          solution: 'cad-plus.sln'
          platform: '$(BuildPlatform)'
          configuration: '$(BuildConfiguration)'

      # - task: VSTest@2
      #   displayName: 'Unit test'
      #   inputs:
      #     testAssemblyVer2: |
      #       tests\_build\*.Tests.dll
      #     platform: '$(BuildPlatform)'
      #     configuration: '$(BuildConfiguration)'

      # - task: codesigning@2
      #   displayName: 'Signing .exe files'
      #   inputs:
      #     secureFileId: xarial-code-signing.pfx
      #     signCertPassword: $(CODE_SIGN_CERT_PWD)
      #     files: '_build/*.exe'
      #     timeServer: 'http://timestamp.comodoca.com'
      #     hashingAlgorithm: 'SHA256'
      #     description: 'CAD+ Toolset'

      - task: NuGetCommand@2
        displayName: 'NuGet restore'
        inputs:
          restoreSolution: 'installer\Installer.sln'

      - task: VSBuild@1
        displayName: 'Build installer'
        inputs:
          solution: 'installer\Installer.sln'
          platform: '$(InstallerPlatform)'
          configuration: '$(BuildConfiguration)'

      # - task: codesigning@2
      #   displayName: 'Signing .msi installers'
      #   inputs:
      #     secureFileId: xarial-code-signing.pfx
      #     signCertPassword: $(CODE_SIGN_CERT_PWD)
      #     files: '_build/*.msi'
      #     timeServer: 'http://timestamp.comodoca.com'
      #     hashingAlgorithm: 'SHA256'
      #     description: 'CAD+ Toolset'

      - task: CopyFiles@2
        displayName: 'Copy Installer Files'
        inputs:
          SourceFolder: '_build'
          Contents: '*.msi'
          TargetFolder: '$(Build.ArtifactStagingDirectory)/installer'
      
      - publish: '$(Build.ArtifactStagingDirectory)/installer'
        artifact: 'installer'

# - stage: 'PublishToAppStore'
#   displayName: 'Publish To App Store'
#   dependsOn: 'Build'
#   condition: succeeded()
#   jobs:
#   - job:
#     pool:
#       vmImage: 'ubuntu-latest'

#     steps:
#     - checkout: none

#     - download: current
#       artifact: 'installer'

#     - task: AppCenterDistribute@3
#       inputs:
#         serverEndpoint: 'App Center'
#         appSlug: 'xarial/CAD-Toolset'
#         appFile: '$(Pipeline.Workspace)/installer/CADPlusToolset.msi'
#         buildVersion: '0.2'
#         releaseNotesOption: 'input'
#         releaseNotesInput: '-'
#         isMandatory: true
#         destinationType: 'groups'
#         distributionGroupId: '5f7506b4-03a6-40f7-8a54-57685986f953'